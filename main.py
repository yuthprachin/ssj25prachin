import streamlit as st
import pandas as pd
import plotly.express as px

# --- 1. ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API (Mock Data) ---
def get_disease_api():
    return pd.DataFrame({
        'hosp_name': ['‡∏£‡∏û.‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏≠‡∏†‡∏±‡∏¢‡∏†‡∏π‡πÄ‡∏ö‡∏®‡∏£', '‡∏£‡∏û.‡∏Å‡∏ö‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏û.‡∏ô‡∏≤‡∏î‡∏µ', '‡∏£‡∏û.‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á', '‡∏£‡∏û.‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏ô‡∏ï‡∏Ñ‡∏≤‡∏°', '‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏°‡∏´‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå', '‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏°‡πÇ‡∏´‡∏™‡∏ñ'],
        'cases': [120, 85, 30, 15, 45, 35, 70],
        'target_percent': [90, 80, 95, 85, 70, 80, 90]
    })

def get_pm25_api():
    return pd.DataFrame({
        'hosp_name': ['‡∏£‡∏û.‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏≠‡∏†‡∏±‡∏¢‡∏†‡∏π‡πÄ‡∏ö‡∏®‡∏£', '‡∏£‡∏û.‡∏Å‡∏ö‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏û.‡∏ô‡∏≤‡∏î‡∏µ', '‡∏£‡∏û.‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á', '‡∏£‡∏û.‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏ô‡∏ï‡∏Ñ‡∏≤‡∏°', '‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏°‡∏´‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå', '‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏°‡πÇ‡∏´‡∏™‡∏ñ'],
        'pm_value': [18, 42, 25, 12, 55, 38, 40],
        'safety_limit': [37.5] * 7
    })

def get_kpi_api():
    return pd.DataFrame({
        'district': ['‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏Å‡∏ö‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏≤‡∏î‡∏µ', '‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á', '‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏ô‡∏ï‡∏Ñ‡∏≤‡∏°', '‡∏®‡∏£‡∏µ‡∏°‡∏´‡∏≤‡πÇ‡∏û‡∏ò‡∏¥', '‡∏®‡∏£‡∏µ‡∏°‡πÇ‡∏´‡∏™‡∏ñ'],
        'score': [88, 72, 95, 60, 82, 77, 91],
        'goal': [80] * 7
    })

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á One-Page Report (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å API) ---
def render_hospital_report(df, value_col, target_val, title, unit="‡∏´‡∏ô‡πà‡∏ß‡∏¢"):
    st.subheader(f"üìä {title}")
    
    # --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏´‡∏ô ---
    if "PM2.5" in title:
        # ‡∏Å‡∏£‡∏ì‡∏µ‡∏ù‡∏∏‡πà‡∏ô: ‡πÉ‡∏ä‡πâ pm_value ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö target_val (37.5)
        df['status'] = df[value_col].apply(lambda x: "‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥" if x <= target_val else "‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå")
        pass_label = "‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥"
    else:
        # ‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏£‡∏Ñ: ‡πÉ‡∏ä‡πâ target_percent ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 85
        # (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô value_col ‡πÅ‡∏ó‡∏ô)
        check_col = 'target_percent' if 'target_percent' in df.columns else value_col
        df['status'] = df[check_col].apply(lambda x: "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô" if x >= 85 else "‚ùå ‡∏ï‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå")
        pass_label = "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô"

    # ‡∏™‡πà‡∏ß‡∏ô Metrics
    c1, c2, c3 = st.columns(3)
    c1.metric(f"‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ({unit})", f"{df[value_col].mean():.1f}")
    c2.metric("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå", f"{len(df[df['status'] == pass_label])} ‡πÅ‡∏´‡πà‡∏á")
    c3.metric("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå", f"{len(df[df['status'] != pass_label])} ‡πÅ‡∏´‡πà‡∏á", delta_color="inverse")

    # ‡∏™‡πà‡∏ß‡∏ô Graph
    fig = px.bar(df, x='hosp_name', y=value_col, color='status', 
                 title=f"‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: {title}",
                 color_discrete_map={"‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥": "#2ecc71", "‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå": "#e74c3c", "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô": "#2ecc71", "‚ùå ‡∏ï‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå": "#e74c3c"})
    st.plotly_chart(fig, use_container_width=True)
    
    st.write("### üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    st.dataframe(df, use_container_width=True)

# --- 3. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Logic AI Orchestrator ---
def ai_orchestrator(prompt):
    prompt = prompt.lower()
    if any(k in prompt for k in ["‡πÇ‡∏£‡∏Ñ", "‡∏£‡∏∞‡∏ö‡∏≤‡∏î"]): return "DISEASE"
    if any(k in prompt for k in ["‡∏ù‡∏∏‡πà‡∏ô", "pm2.5", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®"]): return "PM25"
    if any(k in prompt for k in ["kpi", "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", "‡πÄ‡∏Å‡∏ì‡∏ë‡πå"]): return "KPI"
    return "UNKNOWN"

# --- 4. ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏ß‡πá‡∏ö (UI) ---
st.set_page_config(page_title="‡∏™‡∏™‡∏à.‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ Intelligence", layout="wide")
st.title("üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏™‡∏™‡∏à.‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ")
st.markdown("---")

with st.sidebar:
    st.header("ü§ñ AI Assistant")
    user_input = st.text_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà:", placeholder="‡πÄ‡∏ä‡πà‡∏ô '‡∏Ç‡∏≠‡∏î‡∏π KPI ‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô ‡πÇ‡∏£‡∏Ñ'")
    st.info("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")
    if st.button("‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠"): st.rerun()

# --- 5. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å (Main Logic) ---
if user_input:
    intent = ai_orchestrator(user_input)
    
    if intent == "DISEASE":
        df = get_disease_api()
        render_hospital_report(df, 'cases', 85, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î", "‡∏£‡∏≤‡∏¢")
        
    elif intent == "PM25":
        df = get_pm25_api()
        render_hospital_report(df, 'pm_value', 37.5, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ù‡∏∏‡πà‡∏ô PM 2.5", "¬µg/m¬≥")

    elif intent == "KPI":
        st.subheader("üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠)")
        df_kpi = get_kpi_api()
        
        avg_score = df_kpi['score'].mean()
        pass_count = len(df_kpi[df_kpi['score'] >= 80])
        
        c1, c2 = st.columns(2)
        c1.metric("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", f"{avg_score:.2f} %", delta=f"{avg_score-80:.2f}")
        c2.metric("‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå (80%)", f"{pass_count} / {len(df_kpi)} ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠")

        fig_kpi = px.line(df_kpi, x='district', y=['score', 'goal'], 
                          title="‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢",
                          markers=True,
                          color_discrete_map={"score": "#3498db", "goal": "#e74c3c"})
        st.plotly_chart(fig_kpi, use_container_width=True)
        
        low_districts = df_kpi[df_kpi['score'] < 80]['district'].tolist()
        if low_districts:
            st.warning(f"‚ö†Ô∏è **‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏à‡∏≤‡∏Å AI:** ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà: **{', '.join(low_districts)}**")
        else:
            st.success("üéâ **‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏à‡∏≤‡∏Å AI:** ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
        
        st.write("### üìù ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ KPI ‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠")
        st.table(df_kpi)

    else:
        # ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
        st.error("ü§ñ: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô '‡πÇ‡∏£‡∏Ñ', '‡∏ù‡∏∏‡πà‡∏ô' ‡∏´‡∏£‡∏∑‡∏≠ 'KPI'")

else:
    # ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢
    st.write("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà Sidebar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå")